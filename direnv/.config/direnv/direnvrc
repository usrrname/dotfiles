echo "ðŸš€ Loading global direnvrc..."

# ---- NodeJS fnm ----
# Load fnm based on project context
# 1. If a .nvmrc or .node-version file exists â‡’ ensure that version is installed & used.
# 2. Else if a package.json exists â‡’ just source fnm so it's available on-demand.
#
# Sources:
# - https://blog.ffff.lt/posts/direnv-and-nvmrc/
# - https://github.com/Schniz/fnm

use_fnm() {
    # fnm use automatically detects .nvmrc or .node-version and switches to that version
    # It will also install the version if it's not already installed
    fnm use
}

# Initialize fnm if not already initialized
if ! command -v fnm &> /dev/null; then
    # Try to source fnm from common locations
    if [[ -s "$HOME/.fnm/fnm" ]]; then
        eval "$("$HOME/.fnm/fnm" env --use-on-cd)"
    elif [[ -s "$HOME/.local/share/fnm/fnm" ]]; then
        eval "$("$HOME/.local/share/fnm/fnm" env --use-on-cd)"
    fi
fi

if [[ -f ".nvmrc" ]] || [[ -f ".node-version" ]]; then
    # fnm use automatically handles version detection, installation, and switching
    use_fnm
elif [[ -f "package.json" ]]; then
    # No .nvmrc/.node-version, but JavaScript project detected â†’ just source fnm for convenience
    # Ensure fnm is available in PATH
    if command -v fnm &> /dev/null; then
        echo "âœ¨ fnm available due to package.json (no .nvmrc/.node-version found)."
    fi
fi


# Auto-source dotfiles .envrc in every directory if not inside dotfiles directory
# or it will load twice
if [[ $PWD != "$HOME/.dotfiles" && -f .git ]]; then
    dotenv_if_exists
    source_env_if_exists "$HOME/.dotfiles/.envrc"
    source_env_if_exists "$HOME/.dotfiles/.env.secret" 
fi

# Suppress direnv export output
export DIRENV_LOG_FORMAT=""

# php composer
if [[ -f composer.json ]]; then
    PATH_add vendor/bin
fi
